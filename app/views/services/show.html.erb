<div class="container my-4 service-show">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <div class="d-flex justify-content-between">
      <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to @service.category.presence || "Cleaning", services_path(category: @service.category) %></li>
        <li class="breadcrumb-item active" aria-current="page"><%= @service.sub_category.presence || "House Cleaning" %></li>
      </ol>
        <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to "Volver a Servicios" || "Lista de Servicios", services_path(category: @service.category) %></li>
      </ol>
    </div>
  </nav>

  <div class="row g-4">
    <!-- LEFT -->
    <div class="col-lg-8">
      <h1 class="h2 mb-2"><%= @service.sub_category.presence || "Servicio" %> - <%= @service.user.first_name %></h1>
      <p class="text-muted">
        <%= @service.description.presence || "Professional house cleaning services tailored to your needs. Eco-friendly products and experienced cleaners for a spotless home." %>
      </p>

      <!-- Gallery -->
      <div class="service-gallery mb-4">
        <div class="row g-3 row-cols-1 row-cols-sm-2">
          <% if @service.respond_to?(:images) && @service.images.attached? %>
            <% @service.images.limit(4).each do |img| %>
              <div class="col">
                <%= image_tag img.variant(resize_to_fill: [900, 600]), class: "img-fluid rounded-3 service-gallery-img w-100 h-100 object-fit-cover" %>
              </div>
            <% end %>
          <% else %>
            <% 4.times do %>
              <div class="col">
                <img class="img-fluid rounded-3 service-gallery-img" src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1600&auto=format&fit=crop" alt="Service photo">
              </div>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Provider card -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Sobre este Proveedor</h2>
          <div class="d-flex align-items-center gap-3">
            <div class="flex-shrink-0">
            <% if @service.user.user_photo.attached? %>
              <%= cl_image_tag @service.user.user_photo.key,
                    width: 64, height: 64, crop: "fill", gravity: "auto",
                    class: "rounded-circle object-fit-cover", alt: @service.user.first_name %>
            <% end %>
            </div>
            <div>
              <% avg = (@service.reviews.average(:rating)&.to_f || 0).round(1) rescue 0 %>
              <% count = @service.reviews.count rescue 0 %>
              <div class="small text-muted">
                <span class="text-warning me-1"><%= "★" * avg.round %><span class="text-secondary"><%= "☆" * (5-avg.round) %></span></span>
                <%= avg %> (<%= count %> <%= "review".pluralize(count) %>)
              </div>
            </div>
          </div>

          <p class="mt-3 mb-0 text-muted">
            <%= @service.try(:provider_bio).presence || "Experienced, detail-oriented and committed to customer satisfaction." %>
          </p>
        </div>
      </div>

      <!-- Reviews -->
      <div class="reviews">
        <h2 class="h5 mb-3">Reviews</h2>
        <% if @service.reviews.any? %>
          <% @service.reviews.order(created_at: :desc).each do |review| %>
            <div class="border-bottom pb-3 mb-3">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold"><%= review.user&.full_name || "Anonymous" %></div>
                <div class="small text-muted"><%= time_ago_in_words(review.created_at) %> ago</div>
              </div>
              <div class="text-warning small mb-2">
                <%= ("★" * review.rating.to_i).html_safe %><span class="text-secondary"><%= ("☆" * (5 - review.rating.to_i)).html_safe %></span>
              </div>
              <p class="mb-0"><%= review.content %></p>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No hay reviews todavía.</p>
        <% end %>
      </div>
    </div>

    <!-- RIGHT (Booking) -->
    <div class="col-lg-4">
      <%# valores seguros por si no tenés fee/currency aún %>
      <% fee_value = defined?(@service.service_fee) && @service.service_fee.present? ? @service.service_fee : 10 %>
      <% currency_value = defined?(@service.currency) && @service.currency.present? ? @service.currency : "ARS" %>

      <div class="card booking-card shadow-sm sticky-lg-top"
           data-controller="booking"
           data-booking-rate-value="<%= @service.price.to_f %>"
           data-booking-fee-value="<%= fee_value.to_f %>"
           data-booking-currency-value="<%= currency_value %>">
        <div class="card-body">
          <h6 class="fw-bold text-primary" mb-3 fw-bold">Reserva tu Servicio de <%= @service.sub_category %></h6>
          <hr>
          <%= form_with model: [@service, Order.new],
                        url: orders_path(@service),
                        method: :post,
                        local: true,
                        html: { id: "booking-form" } do |f| %>

            <div class="mb-3">
              <label class="form-label">Fecha</label>
              <%= f.date_field :date, class: "form-control", required: true, value: Date.current %>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Hora de inicio</label>
                <%= f.time_field :start_time, class: "form-control",
                                 step: 900, value: "09:00",
                                 data: { booking_target: "start" } %>
              </div>
              <div class="col-6">
                <label class="form-label">Hora de finalización</label>
                <%= f.time_field :end_time, class: "form-control",
                                 step: 900, value: "12:00",
                                 data: { booking_target: "end" } %>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label">Horas</label>
                <%= f.number_field :hours, class: "form-control",
                                   step: 0.5, min: 1, value: 3,
                                   data: { booking_target: "hours" } %>
              </div>
              <div class="col-6">
                <label class="form-label">Unit price</label>
                <input class="form-control" value="<%= @service.price.to_f %>" readonly data-booking-target="unitPrice">
              </div>
            </div>

            <hr>

            <ul class="list-unstyled small">
              <li class="d-flex justify-content-between align-items-center mb-1">
                <span>Subtotal</span>
                <strong data-booking-target="subtotal">$0.00</strong>
              </li>
              <li class="d-flex justify-content-between align-items-center mb-1">
                <span>Fee de servicio</span>
                <strong data-booking-target="fee">$0.00</strong>
              </li>
              <li class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                <span class="fw-semibold">Total</span>
                <strong class="fs-5" data-booking-target="total">$0.00</strong>
              </li>
            </ul>

            <!-- Hidden cents for server validation -->
            <%= f.hidden_field :unit_price_cents, value: (@service.price.to_f * 100).to_i %>
            <%= f.hidden_field :service_fee_cents, data: { booking_target: "feeCents" } %>
            <%= f.hidden_field :subtotal_cents,    data: { booking_target: "subtotalCents" } %>
            <%= f.hidden_field :total_cents,       data: { booking_target: "totalCents" } %>

            <%= f.submit "Book Now", class: "btn btn-primary w-100 mt-2" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% console %>
