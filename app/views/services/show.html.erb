<% content_for :meta_title, "#{@service.sub_category} con #{@service.user.first_name} en #{DEFAULT_META['meta_product_name']}" %>
<% content_for :meta_description, @service.description.presence || "Servicio confiable de #{@service.sub_category} ofrecido por #{@service.user.first_name}." %>
<% content_for :meta_image, @service.images.attached? ? cl_image_path(@service.images.first.key) : cl_image_path(DEFAULT_META['meta_image']) %>

<div class="container my-4 service-show">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <div class="d-flex justify-content-between">
      <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to @service.category.presence || "Servicio", services_path(category: @service.category) %></li>
        <li class="breadcrumb-item active" aria-current="page"><%= @service.sub_category.presence || "Servicio" %></li>
      </ol>
        <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to "Volver a Servicios" || "Lista de Servicios", services_path(category: @service.category) %></li>
      </ol>
    </div>
  </nav>

  <div class="row g-4">
    <!-- LEFT -->
    <div class="col-lg-8">
      <h3 class="border rounded-4 bg-primary text-white p-2 px-3 mb-3"><%= @service.sub_category.presence || "Servicio" %> con <%= @service.user.first_name %></h3>

      <!-- Gallery -->
      <div class="service-gallery mb-4">
        <div class="row g-3 row-cols-1 row-cols-sm-2">
          <% if @service.images.attached? %>
            <% @service.images.limit(4).each do |img| %>
              <div class="col">
                <%= cl_image_tag img.key, class: "img-fluid rounded-3 service-gallery-img w-100 h-100 object-fit-cover shadow-sm rounded-4" %>
              </div>
            <% end %>
          <% else %>
            <% 4.times do %>
              <div class="col">
                <img class="img-fluid rounded-3 service-gallery-img" src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1600&auto=format&fit=crop" alt="Service photo">
              </div>
            <% end %>
          <% end %>
        </div>
          <div class="border d-flex justify-content-start shadow rounded-4 mt-3 p-3 bg-white">
            <%= @service.description.presence || "El Proveedor no agregó aún una descripción para este servicio" %>
          </div>
      </div>

      <!-- Provider card -->
      <div class="card border shadow mb-4 rounded-4 bg-white">
        <div class="card-body">
          <h2 class="h5 mb-3">Rating de <%= @service.sub_category %> con <%= @service.user.first_name %></h2>
          <div class="d-flex align-items-center gap-3">
            <div class="flex-shrink-0">
            <% if @service.user.user_photo.attached? %>
              <%= cl_image_tag @service.user.user_photo.key,
                    width: 64, height: 64, crop: "fill", gravity: "auto",
                    class: "rounded-circle object-fit-cover", alt: @service.user.first_name %>
            <% else %>
              <%= image_tag "avatar.webp", class: "avatar", alt: "supplier  " %>
            <% end %>
            </div>
            <div>
              <% rating = @supplier_avg.to_f %>
              <% full_stars = rating.floor %>
              <% half_star  = ((rating - full_stars) >= 0.5 ? 1 : 0) %>
              <% empty_stars = 5 - full_stars - half_star %>
              <div class="small text-muted">
                <span class="text-warning">
                  <% full_stars.times { %><i class="fa-solid fa-star"></i><% } %>
                  <% if half_star == 1 %><i class="fa-solid fa-star-half-stroke"></i><% end %>
                  <% empty_stars.times { %><i class="fa-regular fa-star"></i><% } %>
                </span>
                <%= rating.round(2) %> (<%= @supplier_count %> <%= "review".pluralize(@supplier_count) %>)
              </div>
            </div>
          </div>

          <p class="mt-3 mb-0 text-muted">
            <%= @service.try(:provider_bio).presence || "" %>
          </p>
        </div>
      </div>

      <!--Reviews con carousel-->
      <div class="reviews">
        <h3 class="bg-success text-white mb-3 p-2 px-3 shadow-sm rounded-4">Reviews</h3>
        <% if @service_supplier_reviews.any? %>
          <div id="reviewsCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <% @service_supplier_reviews.each_with_index do |review, index| %>
                <div class="carousel-item <%= 'active' if index == 0 %>">
                  <div class="bg-white border shadow-sm rounded-4 p-3">
                    <div class="d-flex align-items-start justify-content-between">
                      <div class="d-flex flex-column me-3 flex-shrink-0">
                        <div class="fw-semibold"><%= review.client&.first_name || "Anónimo" %></div>
                        <% filled = review.rating.to_i %>
                        <div class="text-warning small text-nowrap">
                          <%= ("★" * filled + "☆" * (5 - filled)).html_safe %>
                        </div>
                      </div>
                      <p class="small mb-0 flex-grow-1 mx-3"><%= review.content %></p>
                      <div class="small text-muted text-nowrap ms-3">
                        <%= time_ago_in_words(review.created_at) %> ago
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <button class="carousel-control-prev" type="button" data-bs-target="#reviewsCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>

            <button class="carousel-control-next" type="button" data-bs-target="#reviewsCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        <% else %>
          <div class="bg-white text-center text-muted py-4 rounded-4">
            No hay reviews para este servicio.
          </div>
        <% end %>
      </div>
    </div>

    <!-- RIGHT (Booking) -->
    <div class="col-lg-4">
      <%# valores seguros por si no tenés fee/currency aún %>
      <% fee_value = defined?(@service.service_fee) && @service.service_fee.present? ? @service.service_fee : 10 %>
      <% currency_value = defined?(@service.currency) && @service.currency.present? ? @service.currency : "ARS" %>

      <div class="card filters-card shadow-sm"
          data-controller="booking slots"
          data-booking-rate-value="<%= @service.price.to_f %>"
          data-booking-fee-value="<%= fee_value.to_f %>"
          data-booking-currency-value="<%= currency_value %>"
          data-booking-duration-minutes-value="<%= @service.duration_minutes %>"
          data-slots-service-id-value="<%= @service.id %>"
          data-slots-duration-minutes-value="<%= @service.duration_minutes %>"
          data-slots-step-minutes-value="30">
        <div class="card-body">
          <h6 class="fw-bold bg-success shadow-sm text-white p-3 rounded-4 text-center">Reserva <%= @service.sub_category %></h6>
          <hr>
          <%= form_with model: @order, url: orders_path, html: { id: "booking-form" } do |f| %>

            <div class="mb-3">
              <label class="form-label text-primary"><b>Fecha</b></label>
              <%= f.date_field :date,
                  class: "form-select rounded-4",
                  required: true,
                  data: { action: "change->slots#fetch" } %>
            </div>

            <!-- Picker de horarios disponibles (nuevo) -->
            <div class="mb-3">
              <label class="form-label text-primary"><b>Horarios disponibles</b></label>
              <select class="form-select rounded-4"
                      data-slots-target="select"
                      data-action="change->slots#selectSlot"
                      disabled>
                <option value="">Elegí un horario</option>
              </select>
              <small class="text-muted d-block mt-1" data-slots-target="notice"></small>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label text-primary"><b>Hora de inicio</b></label>
                <%= f.time_field :start_time,
                    class: "form-control",
                    step: 1800,
                    data: { booking_target: "start", slots_target: "startInput" },
                    readonly: true %>
              </div>
              <div class="col-6">
                <label class="form-label text-primary"><b>Hora de finalización</b></label>
                <%= f.time_field :end_time,
                    class: "form-control",
                    step: 1800,
                    data: { booking_target: "end", slots_target: "endInput" },
                    readonly: true %>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label text-primary">Cantidad</label>
                <%= f.number_field :quantity,
                      class: "form-control",
                      min: 1, step: 1, value: 1,
                      data: { booking_target: "quantity" } %>
              </div>

              <div class="col-6">
                <label class="form-label text-primary"><b>Precio Unitario</b></label>
                <input class="form-control  " value="<%= @service.price.to_f %>" readonly data-booking-target="unitPrice">
              </div>
            </div>

            <hr>

            <ul class="list-unstyled small">
              <li class="d-flex text-primary fs-6 justify-content-between align-items-center mb-1 fw-bold">
                <span>Subtotal</span>
                <strong data-booking-target="subtotal">$0.00</strong>
              </li>
              <li class="d-flex text-primary fs-6 justify-content-between align-items-center mb-1 fw-bold">
                <span>Tarifa de servicio</span>
                <strong data-booking-target="fee">$0.00</strong>
              </li>
              <li class="d-flex text-secondary fs-5 justify-content-between align-items-center border-top pt-2 mt-2">
                <span class="fw-bold">Total</span>
                <strong class="fs-5" data-booking-target="total">$0.00</strong>
              </li>
            </ul>

            <!-- Hidden cents for server validation -->
            <%= hidden_field_tag :service_fee_percent, fee_value, data: { booking_target: "feePercent" } %>
            <%= f.hidden_field :unit_price_cents, value: (@service.price.to_f * 100).to_i %>
            <%= f.hidden_field :service_fee_cents, data: { booking_target: "feeCents" } %>
            <%= f.hidden_field :subtotal_cents,    data: { booking_target: "subtotalCents" } %>
            <%= f.hidden_field :total_price,       data: { booking_target: "totalCents" } %>
            <%= f.hidden_field :service_id, value: (@service.id) %>

            <%= f.submit "Reserva", class: "btn btn-primary fw-bold fs-5 rounded-4 w-100 mt-2" unless (user_signed_in? && @service.user_id == current_user.id) %>
          <% end %>
        </div>
      </div>
    </div>

  </div>
</div>
