<% content_for :meta_title, "#{@service.sub_category} con #{@service.user.first_name} en #{DEFAULT_META['meta_product_name']}" %>
<% content_for :meta_description, @service.description.presence || "Servicio confiable de #{@service.sub_category} ofrecido por #{@service.user.first_name}." %>
<% content_for :meta_image, @service.images.attached? ? cl_image_path(@service.images.first.key) : cl_image_path(DEFAULT_META['meta_image']) %>

<div class="container my-4 service-show">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <div class="d-flex justify-content-between">
      <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to @service.category.presence || "Servicio", services_path(category: @service.category) %></li>
        <li class="breadcrumb-item active" aria-current="page"><%= @service.sub_category.presence || "Servicio" %></li>
      </ol>
        <ol class="breadcrumb small">
        <li class="breadcrumb-item"><%= link_to "Volver a Servicios" || "Lista de Servicios", services_path(category: @service.category) %></li>
      </ol>
    </div>
  </nav>

  <div class="row g-4">
    <!-- LEFT -->
    <div class="col-lg-8">
      <h3 class="border rounded-4 bg-primary text-white p-2 px-3 mb-3"><%= @service.sub_category.presence || "Servicio" %> con <%= @service.user.first_name %></h3>

      <!-- Gallery -->
      <div class="service-gallery mb-4">
        <div class="row g-3 row-cols-1 row-cols-sm-2">
          <% if @service.images.attached? %>
            <% @service.images.limit(4).each do |img| %>
              <div class="col">
                <%= cl_image_tag img.key, class: "img-fluid rounded-3 service-gallery-img w-100 h-100 object-fit-cover shadow-sm rounded-4" %>
              </div>
            <% end %>
          <% else %>
            <% 4.times do %>
              <div class="col">
                <img class="img-fluid rounded-3 service-gallery-img" src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1600&auto=format&fit=crop" alt="Service photo">
              </div>
            <% end %>
          <% end %>
        </div>
          <div class="border d-flex justify-content-start shadow rounded-4 mt-3 p-3 bg-white">
            <%= @service.description.presence || "El Proveedor no agregó aún una descripción para este servicio" %>
          </div>
      </div>

      <!-- Provider card -->
      <div class="card border shadow mb-4 rounded-4 bg-white">
        <div class="card-body">
          <h2 class="h5 mb-3">Rating de <%= @service.user.first_name %></h2>
          <div class="d-flex align-items-center gap-3">
            <div class="flex-shrink-0">
            <% if @service.user.user_photo.attached? %>
              <%= cl_image_tag @service.user.user_photo.key,
                    width: 64, height: 64, crop: "fill", gravity: "auto",
                    class: "rounded-circle object-fit-cover", alt: @service.user.first_name %>
            <% else %>
              <%= image_tag "avatar.webp", class: "avatar", alt: "supplier  " %>
            <% end %>
            </div>
            <div>
              <% avg = @supplier_avg %>
              <% count = @supplier_count %>
              <div class="small text-muted">
                <span class="text-warning me-1">
                  <%= "★" * avg.round %><span class="text-secondary"><%= "☆" * (5-avg.round) %></span>
                </span>
                <%= avg %> (<%= count %> <%= "review".pluralize(count) %>)
              </div>
            </div>
          </div>

          <p class="mt-3 mb-0 text-muted">
            <%= @service.try(:provider_bio).presence || "" %>
          </p>
        </div>
      </div>

      <!-- Reviews -->
      <div class="reviews">
        <h3 class="bg-success text-white mb-3 p-2 shadow-sm rounded-4">Reviews</h3>
        <% if @service_supplier_reviews.any? %>
          <% @service_supplier_reviews.each do |review| %>
            <div class="bg-white border shadow-sm rounded-4 p-3 mb-3">
              <div class="d-flex align-items-start justify-content-between">
                <div class="d-flex flex-column me-3 flex-shrink-0">
                  <div class="fw-semibold"><%= review.client&.first_name || "Anónimo" %></div>

                  <% filled = review.rating.to_i %>
                  <div class="text-warning small text-nowrap">
                    <%= ("★" * filled + "☆" * (5 - filled)).html_safe %>
                  </div>
                </div>

                <p class="small mb-0 flex-grow-1 mx-3"><%= review.content %></p>

                <div class="small text-muted text-nowrap ms-3">
                  <%= time_ago_in_words(review.created_at) %> ago
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No hay reviews para este servicio.</p>
        <% end %>
      </div>

    </div>

    <!-- RIGHT (Booking) -->
    <div class="col-lg-4">
      <%# valores seguros por si no tenés fee/currency aún %>
      <% fee_value = defined?(@service.service_fee) && @service.service_fee.present? ? @service.service_fee : 10 %>
      <% currency_value = defined?(@service.currency) && @service.currency.present? ? @service.currency : "ARS" %>

      <div class="card booking-card shadow rounded-4"
          data-controller="booking slots"
          data-booking-rate-value="<%= @service.price.to_f %>"
          data-booking-fee-value="<%= fee_value.to_f %>"
          data-booking-currency-value="<%= currency_value %>"
          data-slots-service-id-value="<%= @service.id %>"
          data-slots-duration-minutes-value="<%= @service.duration_minutes %>"
          data-slots-step-minutes-value="30">
        <div class="card-body">
          <h6 class="fw-bold bg-success shadow-sm text-white p-3 rounded-4">Reserva <%= @service.sub_category %></h6>
          <hr>

          <%= form_with model: @order, url: orders_path, html: { id: "booking-form" } do |f| %>

            <div class="mb-3">
              <label class="form-label">Fecha</label>
              <%= f.date_field :date,
                  class: "form-control bg-white",
                  required: true,
                  data: { action: "change->slots#fetch" } %>
            </div>

            <!-- Picker de horarios disponibles (nuevo) -->
            <div class="mb-3">
              <label class="form-label">Horarios disponibles</label>
              <select class="form-select rounded-4 bg-white"
                      data-slots-target="select"
                      data-action="change->slots#selectSlot"
                      disabled>
                <option value="">Elegí un horario</option>
              </select>
              <small class="text-muted d-block mt-1" data-slots-target="notice"></small>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Hora de inicio</label>
                <%= f.time_field :start_time,
                    class: "form-control bg-white",
                    step: 1800,
                    data: { booking_target: "start", slots_target: "startInput" },
                    readonly: true %>
              </div>
              <div class="col-6">
                <label class="form-label">Hora de finalización</label>
                <%= f.time_field :end_time,
                    class: "form-control bg-white",
                    step: 1800,
                    data: { booking_target: "end", slots_target: "endInput" },
                    readonly: true %>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label">Horas</label>
                <%= f.number_field :hours,
                    class: "form-control bg-white",
                    step: 0.5, min: 1,
                    data: { booking_target: "hours", slots_target: "hours" },
                    readonly: true %>
              </div>
              <div class="col-6">
                <label class="form-label">Precio Unitario</label>
                <input class="form-control bg-white" value="<%= @service.price.to_f %>" readonly data-booking-target="unitPrice">
              </div>
            </div>

            <hr>

            <ul class="list-unstyled small">
              <li class="d-flex justify-content-between align-items-center mb-1 fw-bold">
                <span>Subtotal</span>
                <strong data-booking-target="subtotal">$0.00</strong>
              </li>
              <li class="d-flex justify-content-between align-items-center mb-1 fw-bold">
                <span>Tarifa de servicio</span>
                <strong data-booking-target="fee">$0.00</strong>
              </li>
              <li class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                <span class="fw-bold">TOTAL</span>
                <strong class="fs-5" data-booking-target="total">$0.00</strong>
              </li>
            </ul>

            <!-- Hidden cents for server validation -->
            <%= f.hidden_field :unit_price_cents, value: (@service.price.to_f * 100).to_i %>
            <%= f.hidden_field :service_fee_cents, data: { booking_target: "feeCents" } %>
            <%= f.hidden_field :subtotal_cents,    data: { booking_target: "subtotalCents" } %>
            <%= f.hidden_field :total_price,       data: { booking_target: "totalCents" } %>
            <%= f.hidden_field :service_id, value: (@service.id) %>

            <%= f.submit "Reserva", class: "btn btn-primary fw-bold rounded-4 w-100 mt-2" unless (user_signed_in? && @service.user_id == current_user.id) %>
          <% end %>
        </div>
      </div>
    </div>

  </div>
</div>
