<% service = local_assigns[:service] || chat.service %>

<div class="card shadow-sm rounded-4 h-100 details-card">
  <div class="card-body details-body">
      <h5 class="fw-bold fs-5 text-primary p-3 details-title">Resumen del servicio</h5>
      <div class="d-flex mb-3">
        <% if service.images.attached? %>
          <%= cl_image_tag service.images.first.key,
                           width: 104,
                           height: 104,
                           crop: "fill",
                           gravity: "auto",
                           class: "rounded-4 object-fit-cover me-3" %>
        <% else %>
          <div class="bg-light rounded-4 d-flex align-items-center justify-content-center text-muted me-3"
               style="width:96px;height:96px">
            <i class="fa-solid fa-image"></i>
          </div>
        <% end %>
        <div>
          <strong><%= service.sub_category %></strong>
          <p class="text-muted text-start small mb-1"><%= service.user.first_name %></p>

            <div>
              <% rating = @service_avg.to_f %>
              <% full_stars = rating.floor %>
              <% half_star  = ((rating - full_stars) >= 0.5 ? 1 : 0) %>
              <% empty_stars = 5 - full_stars - half_star %>
              <div class="small text-muted">
                <span class="text-warning">
                  <% full_stars.times { %><i class="fa-solid fa-star"></i><% } %>
                  <% if half_star == 1 %><i class="fa-solid fa-star-half-stroke"></i><% end %>
                  <% empty_stars.times { %><i class="fa-regular fa-star"></i><% } %>
                </span>
                <%= rating.round(2) %>
              </div>
            </div>

          <%= link_to "Reservar", main_app.service_path(service), data: {turbo: false}, class: "btn btn-primary rounded-4 btn-sm mt-1" %>
        </div>
      </div>
      <p class="text-muted small mb-1"><%= service.description %></p>
    <hr>

    <% order = defined?(@order_for_chat) ? @order_for_chat : chat.order %>
    <% if order.present? %>
      <h6 class="text-center fw-bold mb-2">Última Reserva</h6>
      <p class="mb-1"><strong>Fecha:</strong> <%= l order.date, format: "%d/%m/%Y" %></p>
      <p class="mb-1"><strong>Horario:</strong> <%= order.start_time&.strftime("%H:%M") %> - <%= order.end_time&.strftime("%H:%M") %></p>
      <p class="mb-1">
        <strong>Estado:</strong>
        <% estado = I18n.t("orders.status.#{order.status}", locale: :es, default: order.status.to_s.humanize) %>
        <span class="badge bg-light text-muted border"><%= estado %></span>
      </p>
      <p class="mb-1"><strong>Valor:</strong> $<%= order.total_price %></p>
      <%= link_to "Ver orden", order_path(order), class: "btn btn-primary rounded-4 btn-sm mt-1 details-order-link" %>
    <% else %>
      <p class="text-muted small">
        Todavía no hay una reserva asociada a este servicio.
      </p>
    <% end %>

  </div>
</div>
